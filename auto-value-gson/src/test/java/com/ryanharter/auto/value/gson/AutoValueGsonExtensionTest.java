package com.ryanharter.auto.value.gson;

import com.google.auto.value.processor.AutoValueProcessor;
import com.google.common.collect.ImmutableSet;
import com.google.testing.compile.JavaFileObjects;
import java.util.Arrays;
import javax.tools.JavaFileObject;
import org.junit.Before;
import org.junit.Test;

import static com.google.common.truth.Truth.assertAbout;
import static com.google.testing.compile.JavaSourceSubjectFactory.javaSource;
import static com.google.testing.compile.JavaSourcesSubjectFactory.javaSources;
import static com.ryanharter.auto.value.gson.AutoValueGsonExtension.COLLECTIONS_DEFAULT_TO_EMPTY;

public class AutoValueGsonExtensionTest {

  private JavaFileObject nullable;

  @Before
  public void setup() {
    nullable = JavaFileObjects.forSourceString("com.ryanharter.auto.value.gson.Nullable", ""
        + "package com.ryanharter.auto.value.gson;\n"
        + "import java.lang.annotation.Retention;\n"
        + "import java.lang.annotation.Target;\n"
        + "import static java.lang.annotation.ElementType.METHOD;\n"
        + "import static java.lang.annotation.ElementType.PARAMETER;\n"
        + "import static java.lang.annotation.ElementType.FIELD;\n"
        + "import static java.lang.annotation.RetentionPolicy.SOURCE;\n"
        + "@Retention(SOURCE)\n"
        + "@Target({METHOD, PARAMETER, FIELD})\n"
        + "public @interface Nullable {\n"
        + "}");
  }

  @Test
  public void simple() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.gson.annotations.SerializedName;\n"
        + "import com.ryanharter.auto.value.gson.GsonTypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.TypeAdapterFactory;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import java.io.IOException;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        // Reference type
        + "public abstract String a();\n"
        // Array type
        + "public abstract int[] b();\n"
        // Primitive type
        + "public abstract int c();\n"
        // SerializedName
        + "@SerializedName(\"_D\") public abstract String d();\n"
        // Nullable type
        + "@Nullable abstract String e();\n"
        // Parametrized type, multiple parameters
        + "public abstract ImmutableMap<String, Number> f();\n"
        // Parametrized type, single parameter
        + "public abstract Set<String> g();\n"
        // Nested parameterized type
        + "public abstract Map<String, Set<String>> h();\n"
        // SerializedName with alternate
        + "@SerializedName(value = \"_I\", alternate = {\"_I_1\", \"_I_2\"}) public abstract String i();\n"
        // Nullable collection type
        + "@Nullable public abstract List<String> j();\n"
        // Custom adapter
        + "@GsonTypeAdapter(TestTypeAdapter.class) public abstract String k();\n"
        // Custom adapter with generics
        + "@GsonTypeAdapter(TestListTypeAdapter.class) public abstract List<String> l();\n"
        // Custom adapter factory
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract String m();\n"
        // Custom adapter factory with generics
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract List<String> n();\n"
        // Deeply nested parameterized type
        + "public abstract Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>> o();\n" +
        "  @AutoValue.Builder public static abstract class Builder {\n" +
        "    public abstract Builder a(String a);\n" +
        "    public abstract Builder b(int[] b);\n" +
        "    public abstract Builder c(int c);\n" +
        "    public abstract Builder d(String d);\n" +
        "    public abstract Builder e(String e);\n" +
        "    public abstract Builder f(ImmutableMap<String, Number> f);\n" +
        "    public abstract Builder g(Set<String> g);\n" +
        "    public abstract Builder h(Map<String, Set<String>> h);\n" +
        "    public abstract Builder i(String i);\n" +
        "    public abstract Builder j(List<String> j);\n" +
        "    public abstract Builder k(String k);\n" +
        "    public abstract Builder l(List<String> l);\n" +
        "    public abstract Builder m(String m);\n" +
        "    public abstract Builder n(List<String> n);\n" +
        "    public abstract Builder o(Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>> o);\n" +
        "    public abstract Test build();\n" +
        "  }\n" +
        "  public static class TestTypeAdapter extends TypeAdapter<String> {\n" +
        "    @Override public void write(JsonWriter out, String value) throws IOException {}\n" +
        "    @Override public String read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestListTypeAdapter extends TypeAdapter<List<String>> {\n" +
        "    @Override public void write(JsonWriter out, List<String> value) throws IOException {}\n" +
        "    @Override public List<String> read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestTypeAdapterFactory implements TypeAdapterFactory {\n" +
        "    @Override public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> type) { return null; }\n" +
        "  }\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Integer;\n"
        + "import java.lang.Number;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.util.Collections;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(String a, int[] b, int c, String d, @Nullable String e,\n"
        + "      ImmutableMap<String, Number> f, Set<String> g, Map<String, Set<String>> h, String i,\n"
        + "      @Nullable List<String> j, String k, List<String> l, String m, List<String> n,\n"
        + "      Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>> o) {\n"
        + "    super(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> string_adapter;\n"
        + "    private volatile TypeAdapter<int[]> array__int_adapter;\n"
        + "    private volatile TypeAdapter<Integer> int__adapter;\n"
        + "    private volatile TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter;\n"
        + "    private volatile TypeAdapter<Set<String>> set__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter;\n"
        + "    private volatile TypeAdapter<List<String>> list__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.a());\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<int[]> array__int_adapter = this.array__int_adapter;\n"
        + "        if (array__int_adapter == null) {\n"
        + "          this.array__int_adapter = array__int_adapter = gson.getAdapter(int[].class);\n"
        + "        }\n"
        + "        array__int_adapter.write(jsonWriter, object.b());\n"
        + "      }\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      {\n"
        + "        TypeAdapter<Integer> int__adapter = this.int__adapter;\n"
        + "        if (int__adapter == null) {\n"
        + "          this.int__adapter = int__adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        int__adapter.write(jsonWriter, object.c());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_D\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.d());\n"
        + "      }\n"
        + "      jsonWriter.name(\"e\");\n"
        + "      if (object.e() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.e());\n"
        + "      }\n"
        + "      jsonWriter.name(\"f\");\n"
        + "      if (object.f() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter = this.immutableMap__string_number_adapter;\n"
        + "        if (immutableMap__string_number_adapter == null) {\n"
        + "          this.immutableMap__string_number_adapter = immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "        }\n"
        + "        immutableMap__string_number_adapter.write(jsonWriter, object.f());\n"
        + "      }\n"
        + "      jsonWriter.name(\"g\");\n"
        + "      if (object.g() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Set<String>> set__string_adapter = this.set__string_adapter;\n"
        + "        if (set__string_adapter == null) {\n"
        + "          this.set__string_adapter = set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "        }\n"
        + "        set__string_adapter.write(jsonWriter, object.g());\n"
        + "      }\n"
        + "      jsonWriter.name(\"h\");\n"
        + "      if (object.h() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter = this.map__string_set__string_adapter;\n"
        + "        if (map__string_set__string_adapter == null) {\n"
        + "          this.map__string_set__string_adapter = map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "        }\n"
        + "        map__string_set__string_adapter.write(jsonWriter, object.h());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_I\");\n"
        + "      if (object.i() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.i());\n"
        + "      }\n"
        + "      jsonWriter.name(\"j\");\n"
        + "      if (object.j() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.j());\n"
        + "      }\n"
        + "      jsonWriter.name(\"k\");\n"
        + "      if (object.k() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = new Test.TestTypeAdapter();\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.k());\n"
        + "      }\n"
        + "      jsonWriter.name(\"l\");\n"
        + "      if (object.l() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "      TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.l());\n"
        + "      }\n"
        + "      jsonWriter.name(\"m\");\n"
        + "      if (object.m() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.m());\n"
        + "      }\n"
        + "      jsonWriter.name(\"n\");\n"
        + "      if (object.n() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.n());\n"
        + "      }\n"
        + "      jsonWriter.name(\"o\");\n"
        + "      if (object.o() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> map__string_map__string_map__string_map__string_map__string_string_adapter = this.map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "        if (map__string_map__string_map__string_map__string_map__string_string_adapter == null) {\n"
        + "          this.map__string_map__string_map__string_map__string_map__string_string_adapter = map__string_map__string_map__string_map__string_map__string_string_adapter = (TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, String.class).getType()).getType()).getType()).getType()));\n"
        + "        }\n"
        + "        map__string_map__string_map__string_map__string_map__string_string_adapter.write(jsonWriter, object.o());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      String a = null;\n"
        + "      int[] b = null;\n"
        + "      int c = 0;\n"
        + "      String d = null;\n"
        + "      String e = null;\n"
        + "      ImmutableMap<String, Number> f = ImmutableMap.of();\n"
        + "      Set<String> g = Collections.emptySet();\n"
        + "      Map<String, Set<String>> h = Collections.emptyMap();\n"
        + "      String i = null;\n"
        + "      List<String> j = null;\n"
        + "      String k = null;\n"
        + "      List<String> l = Collections.emptyList();\n"
        + "      String m = null;\n"
        + "      List<String> n = Collections.emptyList();\n"
        + "      Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>> o = Collections.emptyMap();\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<int[]> array__int_adapter = this.array__int_adapter;\n"
        + "            if (array__int_adapter == null) {\n"
        + "              this.array__int_adapter = array__int_adapter = gson.getAdapter(int[].class);\n"
        + "            }\n"
        + "            b = array__int_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Integer> int__adapter = this.int__adapter;\n"
        + "            if (int__adapter == null) {\n"
        + "              this.int__adapter = int__adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            c = int__adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_D\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"e\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            e = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"f\": {\n"
        + "            TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter = this.immutableMap__string_number_adapter;\n"
        + "            if (immutableMap__string_number_adapter == null) {\n"
        + "              this.immutableMap__string_number_adapter = immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "            }\n"
        + "            f = immutableMap__string_number_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"g\": {\n"
        + "            TypeAdapter<Set<String>> set__string_adapter = this.set__string_adapter;\n"
        + "            if (set__string_adapter == null) {\n"
        + "              this.set__string_adapter = set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "            }\n"
        + "            g = set__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"h\": {\n"
        + "            TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter = this.map__string_set__string_adapter;\n"
        + "            if (map__string_set__string_adapter == null) {\n"
        + "              this.map__string_set__string_adapter = map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "            }\n"
        + "            h = map__string_set__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_I_1\":\n"
        + "          case \"_I_2\":\n"
        + "          case \"_I\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            i = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"j\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            j = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"k\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = new Test.TestTypeAdapter();\n"
        + "            }\n"
        + "            k = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"l\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "            }\n"
        + "            l = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"m\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "            }\n"
        + "            m = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"n\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            n = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"o\": {\n"
        + "            TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> map__string_map__string_map__string_map__string_map__string_string_adapter = this.map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "            if (map__string_map__string_map__string_map__string_map__string_string_adapter == null) {\n"
        + "              this.map__string_map__string_map__string_map__string_map__string_string_adapter = map__string_map__string_map__string_map__string_map__string_string_adapter = (TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, String.class).getType()).getType()).getType()).getType()));\n"
        + "            }\n"
        + "            o = map__string_map__string_map__string_map__string_map__string_string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o);\n"
        + "    }\n"
        + "  }\n"
        + "}"
    );

    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + COLLECTIONS_DEFAULT_TO_EMPTY + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test public void simpleNoEmpty() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.gson.annotations.SerializedName;\n"
        + "import com.ryanharter.auto.value.gson.GsonTypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.TypeAdapterFactory;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import java.io.IOException;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        // Reference type
        + "public abstract String a();\n"
        // Array type
        + "public abstract int[] b();\n"
        // Primitive type
        + "public abstract int c();\n"
        // SerializedName
        + "@SerializedName(\"_D\") public abstract String d();\n"
        // Nullable type
        + "@Nullable abstract String e();\n"
        // Parametrized type, multiple parameters
        + "public abstract ImmutableMap<String, Number> f();\n"
        // Parametrized type, single parameter
        + "public abstract Set<String> g();\n"
        // Nested parameterized type
        + "public abstract Map<String, Set<String>> h();\n"
        // SerializedName with alternate
        + "@SerializedName(value = \"_I\", alternate = {\"_I_1\", \"_I_2\"}) public abstract String i();\n"
        // Nullable collection type
        + "@Nullable public abstract List<String> j();\n"
        // Custom adapter
        + "@GsonTypeAdapter(TestTypeAdapter.class) public abstract String k();\n"
        // Custom adapter with generics
        + "@GsonTypeAdapter(TestListTypeAdapter.class) public abstract List<String> l();\n"
        // Custom adapter factory
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract String m();\n"
        // Custom adapter factory with generics
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract List<String> n();\n" +
        "  @AutoValue.Builder public static abstract class Builder {\n" +
        "    public abstract Builder a(String a);\n" +
        "    public abstract Builder b(int[] b);\n" +
        "    public abstract Builder c(int c);\n" +
        "    public abstract Builder d(String d);\n" +
        "    public abstract Builder e(String e);\n" +
        "    public abstract Builder f(ImmutableMap<String, Number> f);\n" +
        "    public abstract Builder g(Set<String> g);\n" +
        "    public abstract Builder h(Map<String, Set<String>> h);\n" +
        "    public abstract Builder i(String i);\n" +
        "    public abstract Builder j(List<String> j);\n" +
        "    public abstract Builder k(String k);\n" +
        "    public abstract Builder l(List<String> l);\n" +
        "    public abstract Builder m(String m);\n" +
        "    public abstract Builder n(List<String> n);\n" +
        "    public abstract Test build();\n" +
        "  }\n" +
        "  public static class TestTypeAdapter extends TypeAdapter<String> {\n" +
        "    @Override public void write(JsonWriter out, String value) throws IOException {}\n" +
        "    @Override public String read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestListTypeAdapter extends TypeAdapter<List<String>> {\n" +
        "    @Override public void write(JsonWriter out, List<String> value) throws IOException {}\n" +
        "    @Override public List<String> read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestTypeAdapterFactory implements TypeAdapterFactory {\n" +
        "    @Override public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> type) { return null; }\n" +
        "  }\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Integer;\n"
        + "import java.lang.Number;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(String a, int[] b, int c, String d, @Nullable String e,\n"
        + "      ImmutableMap<String, Number> f, Set<String> g, Map<String, Set<String>> h, String i,\n"
        + "      @Nullable List<String> j, String k, List<String> l, String m, List<String> n) {\n"
        + "    super(a, b, c, d, e, f, g, h, i, j, k, l, m, n);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> string_adapter;\n"
        + "    private volatile TypeAdapter<int[]> array__int_adapter;\n"
        + "    private volatile TypeAdapter<Integer> int__adapter;\n"
        + "    private volatile TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter;\n"
        + "    private volatile TypeAdapter<Set<String>> set__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter;\n"
        + "    private volatile TypeAdapter<List<String>> list__string_adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.a());\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<int[]> array__int_adapter = this.array__int_adapter;\n"
        + "        if (array__int_adapter == null) {\n"
        + "          this.array__int_adapter = array__int_adapter = gson.getAdapter(int[].class);\n"
        + "        }\n"
        + "        array__int_adapter.write(jsonWriter, object.b());\n"
        + "      }\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      {\n"
        + "        TypeAdapter<Integer> int__adapter = this.int__adapter;\n"
        + "        if (int__adapter == null) {\n"
        + "          this.int__adapter = int__adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        int__adapter.write(jsonWriter, object.c());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_D\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.d());\n"
        + "      }\n"
        + "      jsonWriter.name(\"e\");\n"
        + "      if (object.e() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.e());\n"
        + "      }\n"
        + "      jsonWriter.name(\"f\");\n"
        + "      if (object.f() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter = this.immutableMap__string_number_adapter;\n"
        + "        if (immutableMap__string_number_adapter == null) {\n"
        + "          this.immutableMap__string_number_adapter = immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "        }\n"
        + "        immutableMap__string_number_adapter.write(jsonWriter, object.f());\n"
        + "      }\n"
        + "      jsonWriter.name(\"g\");\n"
        + "      if (object.g() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Set<String>> set__string_adapter = this.set__string_adapter;\n"
        + "        if (set__string_adapter == null) {\n"
        + "          this.set__string_adapter = set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "        }\n"
        + "        set__string_adapter.write(jsonWriter, object.g());\n"
        + "      }\n"
        + "      jsonWriter.name(\"h\");\n"
        + "      if (object.h() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter = this.map__string_set__string_adapter;\n"
        + "        if (map__string_set__string_adapter == null) {\n"
        + "          this.map__string_set__string_adapter = map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "        }\n"
        + "        map__string_set__string_adapter.write(jsonWriter, object.h());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_I\");\n"
        + "      if (object.i() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.i());\n"
        + "      }\n"
        + "      jsonWriter.name(\"j\");\n"
        + "      if (object.j() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.j());\n"
        + "      }\n"
        + "      jsonWriter.name(\"k\");\n"
        + "      if (object.k() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = new Test.TestTypeAdapter();\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.k());\n"
        + "      }\n"
        + "      jsonWriter.name(\"l\");\n"
        + "      if (object.l() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.l());\n"
        + "      }\n"
        + "      jsonWriter.name(\"m\");\n"
        + "      if (object.m() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.m());\n"
        + "      }\n"
        + "      jsonWriter.name(\"n\");\n"
        + "      if (object.n() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.n());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      String a = null;\n"
        + "      int[] b = null;\n"
        + "      int c = 0;\n"
        + "      String d = null;\n"
        + "      String e = null;\n"
        + "      ImmutableMap<String, Number> f = null;\n"
        + "      Set<String> g = null;\n"
        + "      Map<String, Set<String>> h = null;\n"
        + "      String i = null;\n"
        + "      List<String> j = null;\n"
        + "      String k = null;\n"
        + "      List<String> l = null;\n"
        + "      String m = null;\n"
        + "      List<String> n = null;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<int[]> array__int_adapter = this.array__int_adapter;\n"
        + "            if (array__int_adapter == null) {\n"
        + "              this.array__int_adapter = array__int_adapter = gson.getAdapter(int[].class);\n"
        + "            }\n"
        + "            b = array__int_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Integer> int__adapter = this.int__adapter;\n"
        + "            if (int__adapter == null) {\n"
        + "              this.int__adapter = int__adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            c = int__adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_D\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"e\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            e = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"f\": {\n"
        + "            TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter = this.immutableMap__string_number_adapter;\n"
        + "            if (immutableMap__string_number_adapter == null) {\n"
        + "              this.immutableMap__string_number_adapter = immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "            }\n"
        + "            f = immutableMap__string_number_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"g\": {\n"
        + "            TypeAdapter<Set<String>> set__string_adapter = this.set__string_adapter;\n"
        + "            if (set__string_adapter == null) {\n"
        + "              this.set__string_adapter = set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "            }\n"
        + "            g = set__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"h\": {\n"
        + "            TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter = this.map__string_set__string_adapter;\n"
        + "            if (map__string_set__string_adapter == null) {\n"
        + "              this.map__string_set__string_adapter = map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "            }\n"
        + "            h = map__string_set__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_I_1\":\n"
        + "          case \"_I_2\":\n"
        + "          case \"_I\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            i = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"j\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            j = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"k\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = new Test.TestTypeAdapter();\n"
        + "            }\n"
        + "            k = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"l\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "            }\n"
        + "            l = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"m\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "            }\n"
        + "            m = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"n\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            n = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e, f, g, h, i, j, k, l, m, n);\n"
        + "    }\n"
        + "  }\n"
        + "}"
    );

    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test public void simpleWithDefaults() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.gson.annotations.SerializedName;\n"
        + "import com.ryanharter.auto.value.gson.GsonTypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.TypeAdapterFactory;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import java.io.IOException;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        // Reference type
        + "public abstract String a();\n"
        // Array type
        + "public abstract int[] b();\n"
        // Primitive type
        + "public abstract int c();\n"
        // SerializedName
        + "@SerializedName(\"_D\") public abstract String d();\n"
        // Nullable type
        + "@Nullable abstract String e();\n"
        // Parametrized type, multiple parameters
        + "public abstract ImmutableMap<String, Number> f();\n"
        // Parametrized type, single parameter
        + "public abstract Set<String> g();\n"
        // Nested parameterized type
        + "public abstract Map<String, Set<String>> h();\n"
        // SerializedName with alternate
        + "@SerializedName(value = \"_I\", alternate = {\"_I_1\", \"_I_2\"}) public abstract String i();\n"
        // Nullable collection type
        + "@Nullable public abstract List<String> j();\n"
        // Custom adapter
        + "@GsonTypeAdapter(TestTypeAdapter.class) public abstract String k();\n"
        // Custom adapter with generics
        + "@GsonTypeAdapter(TestListTypeAdapter.class) public abstract List<String> l();\n"
        // Custom adapter factory
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract String m();\n"
        // Custom adapter factory with generics
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract List<String> n();\n" +
        "  @AutoValue.Builder public static abstract class Builder {\n" +
        "    public abstract Builder a(String a);\n" +
        "    public abstract Builder b(int[] b);\n" +
        "    public abstract Builder c(int c);\n" +
        "    public abstract Builder d(String d);\n" +
        "    public abstract Builder e(String e);\n" +
        "    public abstract Builder f(ImmutableMap<String, Number> f);\n" +
        "    public abstract Builder g(Set<String> g);\n" +
        "    public abstract Builder h(Map<String, Set<String>> h);\n" +
        "    public abstract Builder i(String i);\n" +
        "    public abstract Builder j(List<String> j);\n" +
        "    public abstract Builder k(String k);\n" +
        "    public abstract Builder l(List<String> l);\n" +
        "    public abstract Builder m(String m);\n" +
        "    public abstract Builder n(List<String> n);\n" +
        "    public abstract Test build();\n" +
        "  }\n" +
        "  public static class TestTypeAdapter extends TypeAdapter<String> {\n" +
        "    @Override public void write(JsonWriter out, String value) throws IOException {}\n" +
        "    @Override public String read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestListTypeAdapter extends TypeAdapter<List<String>> {\n" +
        "    @Override public void write(JsonWriter out, List<String> value) throws IOException {}\n" +
        "    @Override public List<String> read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestTypeAdapterFactory implements TypeAdapterFactory {\n" +
        "    @Override public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> type) { return null; }\n" +
        "  }\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Integer;\n"
        + "import java.lang.Number;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(String a, int[] b, int c, String d, @Nullable String e,\n"
        + "      ImmutableMap<String, Number> f, Set<String> g, Map<String, Set<String>> h, String i,\n"
        + "      @Nullable List<String> j, String k, List<String> l, String m, List<String> n) {\n"
        + "    super(a, b, c, d, e, f, g, h, i, j, k, l, m, n);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> string_adapter;\n"
        + "    private volatile TypeAdapter<int[]> array__int_adapter;\n"
        + "    private volatile TypeAdapter<Integer> int__adapter;\n"
        + "    private volatile TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter;\n"
        + "    private volatile TypeAdapter<Set<String>> set__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter;\n"
        + "    private volatile TypeAdapter<List<String>> list__string_adapter;\n"
        + "    private final Gson gson;\n"
        + "    private String defaultA = null;\n"
        + "    private int[] defaultB = null;\n"
        + "    private int defaultC = 0;\n"
        + "    private String defaultD = null;\n"
        + "    private String defaultE = null;\n"
        + "    private ImmutableMap<String, Number> defaultF = null;\n"
        + "    private Set<String> defaultG = null;\n"
        + "    private Map<String, Set<String>> defaultH = null;\n"
        + "    private String defaultI = null;\n"
        + "    private List<String> defaultJ = null;\n"
        + "    private String defaultK = null;\n"
        + "    private List<String> defaultL = null;\n"
        + "    private String defaultM = null;\n"
        + "    private List<String> defaultN = null;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.a());\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<int[]> array__int_adapter = this.array__int_adapter;\n"
        + "        if (array__int_adapter == null) {\n"
        + "          this.array__int_adapter = array__int_adapter = gson.getAdapter(int[].class);\n"
        + "        }\n"
        + "        array__int_adapter.write(jsonWriter, object.b());\n"
        + "      }\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      {\n"
        + "        TypeAdapter<Integer> int__adapter = this.int__adapter;\n"
        + "        if (int__adapter == null) {\n"
        + "          this.int__adapter = int__adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        int__adapter.write(jsonWriter, object.c());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_D\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.d());\n"
        + "      }\n"
        + "      jsonWriter.name(\"e\");\n"
        + "      if (object.e() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.e());\n"
        + "      }\n"
        + "      jsonWriter.name(\"f\");\n"
        + "      if (object.f() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter = this.immutableMap__string_number_adapter;\n"
        + "        if (immutableMap__string_number_adapter == null) {\n"
        + "          this.immutableMap__string_number_adapter = immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "        }\n"
        + "        immutableMap__string_number_adapter.write(jsonWriter, object.f());\n"
        + "      }\n"
        + "      jsonWriter.name(\"g\");\n"
        + "      if (object.g() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Set<String>> set__string_adapter = this.set__string_adapter;\n"
        + "        if (set__string_adapter == null) {\n"
        + "          this.set__string_adapter = set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "        }\n"
        + "        set__string_adapter.write(jsonWriter, object.g());\n"
        + "      }\n"
        + "      jsonWriter.name(\"h\");\n"
        + "      if (object.h() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter = this.map__string_set__string_adapter;\n"
        + "        if (map__string_set__string_adapter == null) {\n"
        + "          this.map__string_set__string_adapter = map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "        }\n"
        + "        map__string_set__string_adapter.write(jsonWriter, object.h());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_I\");\n"
        + "      if (object.i() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.i());\n"
        + "      }\n"
        + "      jsonWriter.name(\"j\");\n"
        + "      if (object.j() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.j());\n"
        + "      }\n"
        + "      jsonWriter.name(\"k\");\n"
        + "      if (object.k() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = new Test.TestTypeAdapter();\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.k());\n"
        + "      }\n"
        + "      jsonWriter.name(\"l\");\n"
        + "      if (object.l() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.l());\n"
        + "      }\n"
        + "      jsonWriter.name(\"m\");\n"
        + "      if (object.m() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.m());\n"
        + "      }\n"
        + "      jsonWriter.name(\"n\");\n"
        + "      if (object.n() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "        if (list__string_adapter == null) {\n"
        + "          this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        list__string_adapter.write(jsonWriter, object.n());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      String a = this.defaultA;\n"
        + "      int[] b = this.defaultB;\n"
        + "      int c = this.defaultC;\n"
        + "      String d = this.defaultD;\n"
        + "      String e = this.defaultE;\n"
        + "      ImmutableMap<String, Number> f = this.defaultF;\n"
        + "      Set<String> g = this.defaultG;\n"
        + "      Map<String, Set<String>> h = this.defaultH;\n"
        + "      String i = this.defaultI;\n"
        + "      List<String> j = this.defaultJ;\n"
        + "      String k = this.defaultK;\n"
        + "      List<String> l = this.defaultL;\n"
        + "      String m = this.defaultM;\n"
        + "      List<String> n = this.defaultN;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<int[]> array__int_adapter = this.array__int_adapter;\n"
        + "            if (array__int_adapter == null) {\n"
        + "              this.array__int_adapter = array__int_adapter = gson.getAdapter(int[].class);\n"
        + "            }\n"
        + "            b = array__int_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Integer> int__adapter = this.int__adapter;\n"
        + "            if (int__adapter == null) {\n"
        + "              this.int__adapter = int__adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            c = int__adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_D\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"e\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            e = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"f\": {\n"
        + "            TypeAdapter<ImmutableMap<String, Number>> immutableMap__string_number_adapter = this.immutableMap__string_number_adapter;\n"
        + "            if (immutableMap__string_number_adapter == null) {\n"
        + "              this.immutableMap__string_number_adapter = immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "            }\n"
        + "            f = immutableMap__string_number_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"g\": {\n"
        + "            TypeAdapter<Set<String>> set__string_adapter = this.set__string_adapter;\n"
        + "            if (set__string_adapter == null) {\n"
        + "              this.set__string_adapter = set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "            }\n"
        + "            g = set__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"h\": {\n"
        + "            TypeAdapter<Map<String, Set<String>>> map__string_set__string_adapter = this.map__string_set__string_adapter;\n"
        + "            if (map__string_set__string_adapter == null) {\n"
        + "              this.map__string_set__string_adapter = map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "            }\n"
        + "            h = map__string_set__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_I_1\":\n"
        + "          case \"_I_2\":\n"
        + "          case \"_I\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            i = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"j\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            j = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"k\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = new Test.TestTypeAdapter();\n"
        + "            }\n"
        + "            k = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"l\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "            }\n"
        + "            l = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"m\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "            }\n"
        + "            m = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"n\": {\n"
        + "            TypeAdapter<List<String>> list__string_adapter = this.list__string_adapter;\n"
        + "            if (list__string_adapter == null) {\n"
        + "              this.list__string_adapter = list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            n = list__string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e, f, g, h, i, j, k, l, m, n);\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultA(String defaultA) {\n"
        + "      this.defaultA = defaultA;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultB(int[] defaultB) {\n"
        + "      this.defaultB = defaultB;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultC(int defaultC) {\n"
        + "      this.defaultC = defaultC;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultD(String defaultD) {\n"
        + "      this.defaultD = defaultD;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultE(String defaultE) {\n"
        + "      this.defaultE = defaultE;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultF(ImmutableMap<String, Number> defaultF) {\n"
        + "      this.defaultF = defaultF;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultG(Set<String> defaultG) {\n"
        + "      this.defaultG = defaultG;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultH(Map<String, Set<String>> defaultH) {\n"
        + "      this.defaultH = defaultH;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultI(String defaultI) {\n"
        + "      this.defaultI = defaultI;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultJ(List<String> defaultJ) {\n"
        + "      this.defaultJ = defaultJ;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultK(String defaultK) {\n"
        + "      this.defaultK = defaultK;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultL(List<String> defaultL) {\n"
        + "      this.defaultL = defaultL;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultM(String defaultM) {\n"
        + "      this.defaultM = defaultM;\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultN(List<String> defaultN) {\n"
        + "      this.defaultN = defaultN;\n"
        + "      return this;\n"
        + "    }\n"
        + "  }\n"
        + "}"
    );

    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + AutoValueGsonExtension.MUTABLE_ADAPTERS_WITH_DEFAULT_SETTERS + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test public void propertyMethodReferencedWithPrefix() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        + "  public abstract String getName();\n"
        + "  public abstract boolean isAwesome();\n"
        + "}"
    );
    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Boolean;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(String name, boolean awesome) {\n"
        + "    super(name, awesome);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> string_adapter;\n"
        + "    private volatile TypeAdapter<Boolean> boolean__adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"name\");\n"
        + "      if (object.getName() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.getName());\n"
        + "      }\n"
        + "      jsonWriter.name(\"awesome\");\n"
        + "      {\n"
        + "        TypeAdapter<Boolean> boolean__adapter = this.boolean__adapter;\n"
        + "        if (boolean__adapter == null) {\n"
        + "          this.boolean__adapter = boolean__adapter = gson.getAdapter(Boolean.class);\n"
        + "        }\n"
        + "        boolean__adapter.write(jsonWriter, object.isAwesome());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      String name = null;\n"
        + "      boolean awesome = false;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"name\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            name = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"awesome\": {\n"
        + "            TypeAdapter<Boolean> boolean__adapter = this.boolean__adapter;\n"
        + "            if (boolean__adapter == null) {\n"
        + "              this.boolean__adapter = boolean__adapter = gson.getAdapter(Boolean.class);\n"
        + "            }\n"
        + "            awesome = boolean__adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(name, awesome);\n"
        + "    }\n"
        + "  }\n"
        + "}");

    assertAbout(javaSource())
        .that(source)
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }
  @Test public void handlesDefaultAccessTypeAdapterMethod() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
            + "package test;\n"
            + "import com.google.auto.value.AutoValue;\n"
            + "import com.google.gson.Gson;\n"
            + "import com.google.gson.TypeAdapter;\n"
            + "@AutoValue abstract class Test {\n"
            + "  static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
            + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
            + "  }\n"
            + "  abstract String getName();\n"
            + "  abstract boolean isAwesome();\n"
            + "}"
    );
    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Boolean;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(String name, boolean awesome) {\n"
        + "    super(name, awesome);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> string_adapter;\n"
        + "    private volatile TypeAdapter<Boolean> boolean__adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"name\");\n"
        + "      if (object.getName() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.getName());\n"
        + "      }\n"
        + "      jsonWriter.name(\"awesome\");\n"
        + "      {\n"
        + "        TypeAdapter<Boolean> boolean__adapter = this.boolean__adapter;\n"
        + "        if (boolean__adapter == null) {\n"
        + "          this.boolean__adapter = boolean__adapter = gson.getAdapter(Boolean.class);\n"
        + "        }\n"
        + "        boolean__adapter.write(jsonWriter, object.isAwesome());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      String name = null;\n"
        + "      boolean awesome = false;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"name\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            name = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"awesome\": {\n"
        + "            TypeAdapter<Boolean> boolean__adapter = this.boolean__adapter;\n"
        + "            if (boolean__adapter == null) {\n"
        + "              this.boolean__adapter = boolean__adapter = gson.getAdapter(Boolean.class);\n"
        + "            }\n"
        + "            awesome = boolean__adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(name, awesome);\n"
        + "    }\n"
        + "  }\n"
        + "}");

    assertAbout(javaSource())
            .that(source)
            .processedWith(new AutoValueProcessor())
            .compilesWithoutError()
            .and()
            .generatesSources(expected);
  }

  @Test public void generatesNothingWithoutTypeAdapterMethod() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public abstract String a();\n"
        + "  public abstract boolean b();\n"
        + "}"
    );
    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", ""
        + "package test;\n"
        + "\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\"com.google.auto.value.processor.AutoValueProcessor\")\n"
        + " final class AutoValue_Test extends Test {\n"
        + "\n"
        + "  private final String a;\n"
        + "  private final boolean b;\n"
        + "\n"
        + "  AutoValue_Test(\n"
        + "      String a,\n"
        + "      boolean b) {\n"
        + "    if (a == null) {\n"
        + "      throw new NullPointerException(\"Null a\");\n"
        + "    }\n"
        + "    this.a = a;\n"
        + "    this.b = b;\n"
        + "  }\n"
        + "\n"
        + "  @Override\n"
        + "  public String a() {\n"
        + "    return a;\n"
        + "  }\n"
        + "\n"
        + "  @Override\n"
        + "  public boolean b() {\n"
        + "    return b;\n"
        + "  }\n"
        + "\n"
        + "  @Override\n"
        + "  public String toString() {\n"
        + "    return \"Test{\"\n"
        + "        + \"a=\" + a + \", \"\n"
        + "        + \"b=\" + b\n"
        + "        + \"}\";\n"
        + "  }\n"
        + "\n"
        + "  @Override\n"
        + "  public boolean equals(Object o) {\n"
        + "    if (o == this) {\n"
        + "      return true;\n"
        + "    }\n"
        + "    if (o instanceof Test) {\n"
        + "      Test that = (Test) o;\n"
        + "      return (this.a.equals(that.a()))\n"
        + "           && (this.b == that.b());\n"
        + "    }\n"
        + "    return false;\n"
        + "  }\n"
        + "\n"
        + "  @Override\n"
        + "  public int hashCode() {\n"
        + "    int h$ = 1;\n"
        + "    h$ *= 1000003;\n"
        + "    h$ ^= a.hashCode();\n"
        + "    h$ *= 1000003;\n"
        + "    h$ ^= b ? 1231 : 1237;\n"
        + "    return h$;\n"
        + "  }\n"
        + "\n"
        + "}");

    assertAbout(javaSource())
        .that(source)
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .withWarningCount(2)
        .and()
        .generatesSources(expected);
  }

  @Test public void emitsWarningForWrongTypeAdapterTypeArgument() {
    JavaFileObject source1 = JavaFileObjects.forSourceString("test.Foo", ""
        + "package test;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "@AutoValue public abstract class Foo {\n"
        + "  public static TypeAdapter<Bar> typeAdapter(Gson gson) {\n"
        + "    return null;"
        + "  }\n"
        + "  public abstract String a();\n"
        + "  public abstract boolean b();\n"
        + "}"
    );

    JavaFileObject source2 = JavaFileObjects.forSourceString("test.Bar", ""
        + "package test;\n"
        + "public class Bar {\n"
        + "}");

    assertAbout(javaSources())
        .that(ImmutableSet.of(source1, source2))
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .withWarningContaining("Found public static method returning TypeAdapter<test.Bar> on "
            + "test.Foo class. Skipping GsonTypeAdapter generation.");
  }

  @Test public void emitsWarningForNoTypeAdapterTypeArgument() {
    JavaFileObject source1 = JavaFileObjects.forSourceString("test.Foo", ""
        + "package test;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "@AutoValue public abstract class Foo {\n"
        + "  public static TypeAdapter typeAdapter(Gson gson) {\n"
        + "    return null;"
        + "  }\n"
        + "  public abstract String a();\n"
        + "  public abstract boolean b();\n"
        + "}"
    );

    assertAbout(javaSource())
        .that(source1)
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .withWarningContaining("Found public static method returning TypeAdapter with no type "
            + "arguments, skipping GsonTypeAdapter generation.");
  }

  @Test public void compilesWithCapitalPackageName() {
    JavaFileObject source1 = JavaFileObjects.forSourceString("MyPackage.Foo", ""
        + "package MyPackage;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "@AutoValue public abstract class Foo {\n"
        + "  public static TypeAdapter<Foo> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Foo.GsonTypeAdapter(gson);"
        + "  }\n"
        + "  public abstract String a();\n"
        + "  public abstract boolean b();\n"
        + "}"
    );

    assertAbout(javaSource())
        .that(source1)
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .withWarningCount(2);
  }

  @Test public void generatesCorrectDefaultCharPrimitiveValue() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        + "public abstract char c();\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Character;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(char c) {\n"
        + "    super(c);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<Character> char__adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      {\n"
        + "        TypeAdapter<Character> char__adapter = this.char__adapter;\n"
        + "        if (char__adapter == null) {\n"
        + "          this.char__adapter = char__adapter = gson.getAdapter(Character.class);\n"
        + "        }\n"
        + "        char__adapter.write(jsonWriter, object.c());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      char c = '\\u0000';\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Character> char__adapter = this.char__adapter;\n"
        + "            if (char__adapter == null) {\n"
        + "              this.char__adapter = char__adapter = gson.getAdapter(Character.class);\n"
        + "            }\n"
        + "            c = char__adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(c);\n"
        + "    }\n"
        + "  }\n"
        + "}"
    );

    assertAbout(javaSources())
      .that(Arrays.asList(nullable, source))
      .processedWith(new AutoValueProcessor())
      .compilesWithoutError()
      .and()
      .generatesSources(expected);
  }

  @Test public void handlesGenericTypes() {
    JavaFileObject source1 = JavaFileObjects.forSourceString("test.Foo", ""
        + "package test;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "@AutoValue public abstract class Foo<A, B, C> {\n"
        + "  public static <A, B, C> TypeAdapter<Foo<A, B, C>> typeAdapter(Gson gson, TypeToken<? extends Foo<A, B, C>> typeToken) {\n"
        + "    return new AutoValue_Foo.GsonTypeAdapter(gson, typeToken);"
        + "  }\n"
        + "  public abstract C c();\n"
        + "  public abstract A a();\n"
        + "  public abstract B b();\n"
        + "  public abstract List<A> list();\n"
        + "  public abstract Map<String, List<C>> map();\n"
        + "  public abstract String d();\n"
        + "}"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test.AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.lang.reflect.ParameterizedType;\n"
        + "import java.lang.reflect.Type;\n"
        + "import java.util.Collections;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Foo<A, B, C> extends $AutoValue_Foo<A, B, C> {\n"
        + "  AutoValue_Foo(C c, A a, B b, List<A> list, Map<String, List<C>> map, String d) {\n"
        + "    super(c, a, b, list, map, d);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter<A, B, C> extends TypeAdapter<Foo<A, B, C>> {\n"
        + "    private volatile TypeAdapter<C> C_adapter;\n"
        + "    private volatile TypeAdapter<A> A_adapter;\n"
        + "    private volatile TypeAdapter<B> B_adapter;\n"
        + "    private volatile TypeAdapter<List<A>> list__A_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, List<C>>> map__string_list__C_adapter;\n"
        + "    private volatile TypeAdapter<String> string_adapter;\n"
        + "    private final Gson gson;\n"
        + "    private final Type[] typeArgs\n"
        + "    public GsonTypeAdapter(Gson gson, TypeToken<? extends Foo<A, B, C>> typeToken) {\n"
        + "      ParameterizedType type = (ParameterizedType) typeToken.getType();\n"
        + "      typeArgs = type.getActualTypeArguments();\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Foo<A, B, C> object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      if (object.c() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<C> C_adapter = this.C_adapter;\n"
        + "        if (C_adapter == null) {\n"
        + "          this.C_adapter = C_adapter = (TypeAdapter<C>) gson.getAdapter(TypeToken.get(typeArgs[2]));\n"
        + "        }\n"
        + "        C_adapter.write(jsonWriter, object.c());\n"
        + "      }\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<A> A_adapter = this.A_adapter;\n"
        + "        if (A_adapter == null) {\n"
        + "          this.A_adapter = A_adapter = (TypeAdapter<A>) gson.getAdapter(TypeToken.get(typeArgs[0]));\n"
        + "        }\n"
        + "        A_adapter.write(jsonWriter, object.a());\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<B> B_adapter = this.B_adapter;\n"
        + "        if (B_adapter == null) {\n"
        + "          this.B_adapter = B_adapter = (TypeAdapter<B>) gson.getAdapter(TypeToken.get(typeArgs[1]));\n"
        + "        }\n"
        + "        B_adapter.write(jsonWriter, object.b());\n"
        + "      }\n"
        + "      jsonWriter.name(\"list\");\n"
        + "      if (object.list() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<A>> list__A_adapter = this.list__A_adapter;\n"
        + "        if (list__A_adapter == null) {\n"
        + "          this.list__A_adapter = list__A_adapter = (TypeAdapter<List<A>>) gson.getAdapter(TypeToken.getParameterized(List.class, typeArgs[0]));\n"
        + "        }\n"
        + "        list__A_adapter.write(jsonWriter, object.list());\n"
        + "      }\n"
        + "      jsonWriter.name(\"map\");\n"
        + "      if (object.map() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, List<C>>> map__string_list__C_adapter = this.map__string_list__C_adapter;\n"
        + "        if (map__string_list__C_adapter == null) {\n"
        + "          this.map__string_list__C_adapter = map__string_list__C_adapter = (TypeAdapter<Map<String, List<C>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(List.class, typeArgs[2]).getType()));\n"
        + "        }\n"
        + "        map__string_list__C_adapter.write(jsonWriter, object.map());\n"
        + "      }\n"
        + "      jsonWriter.name(\"d\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.d());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Foo<A, B, C> read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      C c = null;\n"
        + "      A a = null;\n"
        + "      B b = null;\n"
        + "      List<A> list = Collections.emptyList();\n"
        + "      Map<String, List<C>> map = Collections.emptyMap();\n"
        + "      String d = null;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<C> C_adapter = this.C_adapter;\n"
        + "            if (C_adapter == null) {\n"
        + "              this.C_adapter = C_adapter = (TypeAdapter<C>) gson.getAdapter(TypeToken.get(typeArgs[2]));\n"
        + "            }\n"
        + "            c = C_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<A> A_adapter = this.A_adapter;\n"
        + "            if (A_adapter == null) {\n"
        + "              this.A_adapter = A_adapter = (TypeAdapter<A>) gson.getAdapter(TypeToken.get(typeArgs[0]));\n"
        + "            }\n"
        + "            a = A_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<B> B_adapter = this.B_adapter;\n"
        + "            if (B_adapter == null) {\n"
        + "              this.B_adapter = B_adapter = (TypeAdapter<B>) gson.getAdapter(TypeToken.get(typeArgs[1]));\n"
        + "            }\n"
        + "            b = B_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"list\": {\n"
        + "            TypeAdapter<List<A>> list__A_adapter = this.list__A_adapter;\n"
        + "            if (list__A_adapter == null) {\n"
        + "              this.list__A_adapter = list__A_adapter = (TypeAdapter<List<A>>) gson.getAdapter(TypeToken.getParameterized(List.class, typeArgs[0]));\n"
        + "            }\n"
        + "            list = list__A_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"map\": {\n"
        + "            TypeAdapter<Map<String, List<C>>> map__string_list__C_adapter = this.map__string_list__C_adapter;\n"
        + "            if (map__string_list__C_adapter == null) {\n"
        + "              this.map__string_list__C_adapter = map__string_list__C_adapter = (TypeAdapter<Map<String, List<C>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(List.class, typeArgs[2]).getType()));\n"
        + "            }\n"
        + "            map = map__string_list__C_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"d\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Foo<>(c, a, b, list, map, d);\n"
        + "    }\n"
        + "  }\n"
        + "}");

    assertAbout(javaSource())
        .that(source1)
        .withCompilerOptions("-A" + COLLECTIONS_DEFAULT_TO_EMPTY + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test public void ignoresAnnotatedFields() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Ignore;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "@AutoValue public abstract class Test {\n"
        // a is not ignored, must be present in the JSON
        + "  public abstract String a();\n"
        // b is ignored for deserialization and not nullable, so a default value must be set
        + "  @Ignore(Ignore.Type.DESERIALIZATION) public abstract String b();\n"
        // c is ignored for serialization, but may be left out of the json when serializing, so no default is needed
        + "  @Ignore(Ignore.Type.SERIALIZATION) public abstract String c();\n"
        // d is ignored and not nullable, so a default value must be set
        + "  @Ignore public abstract String d();\n"
        // e is nullable and ignored, so a default value is not required
        + "  @Nullable @Ignore public abstract String e();\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        + "}");

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", "package test;\n"
        + "\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(String a, String b, String c, String d, @Nullable String e) {\n"
        + "    super(a, b, c, d, e);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> string_adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.a());\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "        if (string_adapter == null) {\n"
        + "          this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        string_adapter.write(jsonWriter, object.b());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      String a = null;\n"
        + "      String b = null;\n"
        + "      String c = null;\n"
        + "      String d = null;\n"
        + "      String e = null;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<String> string_adapter = this.string_adapter;\n"
        + "            if (string_adapter == null) {\n"
        + "              this.string_adapter = string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            c = string_adapter.read(jsonReader);\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e);\n"
        + "    }\n"
        + "  }\n"
        + "}");

    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test
  public void simpleWithJavaOptional() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.gson.annotations.SerializedName;\n"
        + "import com.ryanharter.auto.value.gson.GsonTypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.TypeAdapterFactory;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import java.io.IOException;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Optional;\n"
        + "import java.util.OptionalDouble;\n"
        + "import java.util.OptionalInt;\n"
        + "import java.util.OptionalLong;\n"
        + "import java.util.Set;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        // Reference type
        + "public abstract Optional<String> a();\n"
        // Array type
        + "public abstract Optional<int[]> b();\n"
        // Boxed Primitive type
        + "public abstract Optional<Integer> c();\n"
        // SerializedName
        + "@SerializedName(\"_D\") public abstract Optional<String> d();\n"
        // Nullable type
        + "@Nullable abstract Optional<String> e();\n"
        // Parametrized type, multiple parameters
        + "public abstract Optional<ImmutableMap<String, Number>> f();\n"
        // Parametrized type, single parameter
        + "public abstract Optional<Set<String>> g();\n"
        // Nested parameterized type
        + "public abstract Optional<Map<String, Set<String>>> h();\n"
        // SerializedName with alternate
        + "@SerializedName(value = \"_I\", alternate = {\"_I_1\", \"_I_2\"}) public abstract Optional<String> i();\n"
        // Nullable collection type
        + "@Nullable public abstract Optional<List<String>> j();\n"
        // Custom adapter
        + "@GsonTypeAdapter(TestTypeAdapter.class) public abstract Optional<String> k();\n"
        // Custom adapter with generics
        + "@GsonTypeAdapter(TestListTypeAdapter.class) public abstract Optional<List<String>> l();\n"
        // Custom adapter factory
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<String> m();\n"
        // Custom adapter factory with generics
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<List<String>> n();\n"
        // Deeply nested parameterized type
        + "public abstract Optional<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> o();\n"
        // Java Optional type wrappers for primitives
        + "public abstract OptionalInt p();\n"
        + "public abstract OptionalLong q();\n"
        + "public abstract OptionalDouble r();\n"
        +
        "  @AutoValue.Builder public static abstract class Builder {\n" +
        "    public abstract Builder a(String a);\n" +
        "    public abstract Builder b(int[] b);\n" +
        "    public abstract Builder c(int c);\n" +
        "    public abstract Builder d(String d);\n" +
        "    public abstract Builder e(String e);\n" +
        "    public abstract Builder f(ImmutableMap<String, Number> f);\n" +
        "    public abstract Builder g(Set<String> g);\n" +
        "    public abstract Builder h(Map<String, Set<String>> h);\n" +
        "    public abstract Builder i(String i);\n" +
        "    public abstract Builder j(List<String> j);\n" +
        "    public abstract Builder k(String k);\n" +
        "    public abstract Builder l(List<String> l);\n" +
        "    public abstract Builder m(String m);\n" +
        "    public abstract Builder n(List<String> n);\n" +
        "    public abstract Builder o(Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>> o);\n" +
        "    public abstract Builder p(int p);\n" +
        "    public abstract Builder q(long q);\n" +
        "    public abstract Builder r(double r);\n" +
        "    public abstract Test build();\n" +
        "  }\n" +
        "  public static class TestTypeAdapter extends TypeAdapter<String> {\n" +
        "    @Override public void write(JsonWriter out, String value) throws IOException {}\n" +
        "    @Override public String read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestListTypeAdapter extends TypeAdapter<List<String>> {\n" +
        "    @Override public void write(JsonWriter out, List<String> value) throws IOException {}\n" +
        "    @Override public List<String> read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestTypeAdapterFactory implements TypeAdapterFactory {\n" +
        "    @Override public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> type) { return null; }\n" +
        "  }\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", ""
        + "package test;\n"
        + "\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Double;\n"
        + "import java.lang.Integer;\n"
        + "import java.lang.Long;\n"
        + "import java.lang.Number;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Optional;\n"
        + "import java.util.OptionalDouble;\n"
        + "import java.util.OptionalInt;\n"
        + "import java.util.OptionalLong;\n"
        + "import java.util.Set;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(Optional<String> a, Optional<int[]> b, Optional<Integer> c, Optional<String> d,\n"
        + "      @Nullable Optional<String> e, Optional<ImmutableMap<String, Number>> f,\n"
        + "      Optional<Set<String>> g, Optional<Map<String, Set<String>>> h, Optional<String> i,\n"
        + "      @Nullable Optional<List<String>> j, Optional<String> k, Optional<List<String>> l,\n"
        + "      Optional<String> m, Optional<List<String>> n,\n"
        + "      Optional<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> o,\n"
        + "      OptionalInt p, OptionalLong q, OptionalDouble r) {\n"
        + "    super(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> optional__string_adapter;\n"
        + "    private volatile TypeAdapter<int[]> optional__array__int_adapter;\n"
        + "    private volatile TypeAdapter<Integer> optional__integer_adapter;\n"
        + "    private volatile TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter;\n"
        + "    private volatile TypeAdapter<Set<String>> optional__set__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter;\n"
        + "    private volatile TypeAdapter<List<String>> optional__list__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> optional__map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "    private volatile TypeAdapter<Integer> optionalInt_adapter;\n"
        + "    private volatile TypeAdapter<Long> optionalLong_adapter;\n"
        + "    private volatile TypeAdapter<Double> optionalDouble_adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.a().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "        if (optional__array__int_adapter == null) {\n"
        + "          this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "        }\n"
        + "        optional__array__int_adapter.write(jsonWriter, object.b().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      if (object.c() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "        if (optional__integer_adapter == null) {\n"
        + "          this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        optional__integer_adapter.write(jsonWriter, object.c().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"_D\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.d().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"e\");\n"
        + "      if (object.e() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.e().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"f\");\n"
        + "      if (object.f() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "        if (optional__immutableMap__string_number_adapter == null) {\n"
        + "          this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "        }\n"
        + "        optional__immutableMap__string_number_adapter.write(jsonWriter, object.f().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"g\");\n"
        + "      if (object.g() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "        if (optional__set__string_adapter == null) {\n"
        + "          this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "        }\n"
        + "        optional__set__string_adapter.write(jsonWriter, object.g().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"h\");\n"
        + "      if (object.h() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "        if (optional__map__string_set__string_adapter == null) {\n"
        + "          this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "        }\n"
        + "        optional__map__string_set__string_adapter.write(jsonWriter, object.h().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"_I\");\n"
        + "      if (object.i() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.i().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"j\");\n"
        + "      if (object.j() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.j().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"k\");\n"
        + "      if (object.k() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.k().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"l\");\n"
        + "      if (object.l() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.l().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"m\");\n"
        + "      if (object.m() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.m().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"n\");\n"
        + "      if (object.n() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.n().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"o\");\n"
        + "      if (object.o() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> optional__map__string_map__string_map__string_map__string_map__string_string_adapter = this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "        if (optional__map__string_map__string_map__string_map__string_map__string_string_adapter == null) {\n"
        + "          this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter = optional__map__string_map__string_map__string_map__string_map__string_string_adapter = (TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, String.class).getType()).getType()).getType()).getType()));\n"
        + "        }\n"
        + "        optional__map__string_map__string_map__string_map__string_map__string_string_adapter.write(jsonWriter, object.o().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"p\");\n"
        + "      if (object.p() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Integer> optionalInt_adapter = this.optionalInt_adapter;\n"
        + "        if (optionalInt_adapter == null) {\n"
        + "          this.optionalInt_adapter = optionalInt_adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        optionalInt_adapter.write(jsonWriter, object.p().orElse(0));\n"
        + "      }\n"
        + "      jsonWriter.name(\"q\");\n"
        + "      if (object.q() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Long> optionalLong_adapter = this.optionalLong_adapter;\n"
        + "        if (optionalLong_adapter == null) {\n"
        + "          this.optionalLong_adapter = optionalLong_adapter = gson.getAdapter(Long.class);\n"
        + "        }\n"
        + "        optionalLong_adapter.write(jsonWriter, object.q().orElse(0L));\n"
        + "      }\n"
        + "      jsonWriter.name(\"r\");\n"
        + "      if (object.r() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Double> optionalDouble_adapter = this.optionalDouble_adapter;\n"
        + "        if (optionalDouble_adapter == null) {\n"
        + "          this.optionalDouble_adapter = optionalDouble_adapter = gson.getAdapter(Double.class);\n"
        + "        }\n"
        + "        optionalDouble_adapter.write(jsonWriter, object.r().orElse(0d));\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      Optional<String> a = Optional.empty();\n"
        + "      Optional<int[]> b = Optional.empty();\n"
        + "      Optional<Integer> c = Optional.empty();\n"
        + "      Optional<String> d = Optional.empty();\n"
        + "      Optional<String> e = Optional.empty();\n"
        + "      Optional<ImmutableMap<String, Number>> f = Optional.empty();\n"
        + "      Optional<Set<String>> g = Optional.empty();\n"
        + "      Optional<Map<String, Set<String>>> h = Optional.empty();\n"
        + "      Optional<String> i = Optional.empty();\n"
        + "      Optional<List<String>> j = Optional.empty();\n"
        + "      Optional<String> k = Optional.empty();\n"
        + "      Optional<List<String>> l = Optional.empty();\n"
        + "      Optional<String> m = Optional.empty();\n"
        + "      Optional<List<String>> n = Optional.empty();\n"
        + "      Optional<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> o = Optional.empty();\n"
        + "      OptionalInt p = OptionalInt.empty();\n"
        + "      OptionalLong q = OptionalLong.empty();\n"
        + "      OptionalDouble r = OptionalDouble.empty();\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "            if (optional__array__int_adapter == null) {\n"
        + "              this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "            }\n"
        + "            b = Optional.of(optional__array__int_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "            if (optional__integer_adapter == null) {\n"
        + "              this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            c = Optional.of(optional__integer_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_D\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"e\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            e = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"f\": {\n"
        + "            TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "            if (optional__immutableMap__string_number_adapter == null) {\n"
        + "              this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "            }\n"
        + "            f = Optional.of(optional__immutableMap__string_number_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"g\": {\n"
        + "            TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "            if (optional__set__string_adapter == null) {\n"
        + "              this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "            }\n"
        + "            g = Optional.of(optional__set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"h\": {\n"
        + "            TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "            if (optional__map__string_set__string_adapter == null) {\n"
        + "              this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "            }\n"
        + "            h = Optional.of(optional__map__string_set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_I_1\":\n"
        + "          case \"_I_2\":\n"
        + "          case \"_I\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            i = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"j\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            j = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"k\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "            }\n"
        + "            k = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"l\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "            }\n"
        + "            l = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"m\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "            }\n"
        + "            m = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"n\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            n = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"o\": {\n"
        + "            TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> optional__map__string_map__string_map__string_map__string_map__string_string_adapter = this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "            if (optional__map__string_map__string_map__string_map__string_map__string_string_adapter == null) {\n"
        + "              this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter = optional__map__string_map__string_map__string_map__string_map__string_string_adapter = (TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, String.class).getType()).getType()).getType()).getType()));\n"
        + "            }\n"
        + "            o = Optional.of(optional__map__string_map__string_map__string_map__string_map__string_string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"p\": {\n"
        + "            TypeAdapter<Integer> optionalInt_adapter = this.optionalInt_adapter;\n"
        + "            if (optionalInt_adapter == null) {\n"
        + "              this.optionalInt_adapter = optionalInt_adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            p = OptionalInt.of(optionalInt_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"q\": {\n"
        + "            TypeAdapter<Long> optionalLong_adapter = this.optionalLong_adapter;\n"
        + "            if (optionalLong_adapter == null) {\n"
        + "              this.optionalLong_adapter = optionalLong_adapter = gson.getAdapter(Long.class);\n"
        + "            }\n"
        + "            q = OptionalLong.of(optionalLong_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"r\": {\n"
        + "            TypeAdapter<Double> optionalDouble_adapter = this.optionalDouble_adapter;\n"
        + "            if (optionalDouble_adapter == null) {\n"
        + "              this.optionalDouble_adapter = optionalDouble_adapter = gson.getAdapter(Double.class);\n"
        + "            }\n"
        + "            r = OptionalDouble.of(optionalDouble_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r);\n"
        + "    }\n"
        + "  }\n"
        + "}\n"
    );

    // Collections default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + COLLECTIONS_DEFAULT_TO_EMPTY + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);

    // Collections do not default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test
  public void simpleWithJavaOptionalAndDefaults() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.gson.annotations.SerializedName;\n"
        + "import com.ryanharter.auto.value.gson.GsonTypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Ignore;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.TypeAdapterFactory;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import java.io.IOException;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Optional;\n"
        + "import java.util.OptionalDouble;\n"
        + "import java.util.OptionalInt;\n"
        + "import java.util.OptionalLong;\n"
        + "import java.util.Set;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        // Reference type
        + "public abstract Optional<String> a();\n"
        // Array type
        + "public abstract Optional<int[]> b();\n"
        // Boxed primitive type
        + "public abstract Optional<Integer> c();\n"
        // SerializedName
        + "@SerializedName(\"_D\") public abstract Optional<String> d();\n"
        // Nullable type
        + "@Nullable abstract Optional<String> e();\n"
        // Parametrized type, multiple parameters
        + "public abstract Optional<ImmutableMap<String, Number>> f();\n"
        // Parametrized type, single parameter
        + "public abstract Optional<Set<String>> g();\n"
        // Nested parameterized type
        + "public abstract Optional<Map<String, Set<String>>> h();\n"
        // SerializedName with alternate
        + "@SerializedName(value = \"_I\", alternate = {\"_I_1\", \"_I_2\"}) public abstract Optional<String> i();\n"
        // Nullable collection type
        + "@Nullable public abstract Optional<List<String>> j();\n"
        // Custom adapter
        + "@GsonTypeAdapter(TestTypeAdapter.class) public abstract Optional<String> k();\n"
        // Custom adapter with generics
        + "@GsonTypeAdapter(TestListTypeAdapter.class) public abstract Optional<List<String>> l();\n"
        // Custom adapter factory
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<String> m();\n"
        // Custom adapter factory with generics
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<List<String>> n();\n"
        // Java Optional type wrappers for primitives
        + "public abstract OptionalInt o();\n"
        + "public abstract OptionalLong p();\n"
        + "public abstract OptionalDouble q();\n"
        // Test case for ignore-deserialize-but-not-nullable
        + "@Ignore(Ignore.Type.DESERIALIZATION) public abstract Optional<String> r();\n"
        +
        "  @AutoValue.Builder public static abstract class Builder {\n" +
        "    public abstract Builder a(String a);\n" +
        "    public abstract Builder b(int[] b);\n" +
        "    public abstract Builder c(int c);\n" +
        "    public abstract Builder d(String d);\n" +
        "    public abstract Builder e(String e);\n" +
        "    public abstract Builder f(ImmutableMap<String, Number> f);\n" +
        "    public abstract Builder g(Set<String> g);\n" +
        "    public abstract Builder h(Map<String, Set<String>> h);\n" +
        "    public abstract Builder i(String i);\n" +
        "    public abstract Builder j(List<String> j);\n" +
        "    public abstract Builder k(String k);\n" +
        "    public abstract Builder l(List<String> l);\n" +
        "    public abstract Builder m(String m);\n" +
        "    public abstract Builder n(List<String> n);\n" +
        "    public abstract Builder o(int o);\n" +
        "    public abstract Builder p(long p);\n" +
        "    public abstract Builder q(double q);\n" +
        "    public abstract Builder r(String r);\n" +
        "    public abstract Test build();\n" +
        "  }\n" +
        "  public static class TestTypeAdapter extends TypeAdapter<String> {\n" +
        "    @Override public void write(JsonWriter out, String value) throws IOException {}\n" +
        "    @Override public String read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestListTypeAdapter extends TypeAdapter<List<String>> {\n" +
        "    @Override public void write(JsonWriter out, List<String> value) throws IOException {}\n" +
        "    @Override public List<String> read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestTypeAdapterFactory implements TypeAdapterFactory {\n" +
        "    @Override public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> type) { return null; }\n" +
        "  }\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", ""
        + "package test;\n"
        + "\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Double;\n"
        + "import java.lang.Integer;\n"
        + "import java.lang.Long;\n"
        + "import java.lang.Number;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Optional;\n"
        + "import java.util.OptionalDouble;\n"
        + "import java.util.OptionalInt;\n"
        + "import java.util.OptionalLong;\n"
        + "import java.util.Set;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(Optional<String> a, Optional<int[]> b, Optional<Integer> c, Optional<String> d,\n"
        + "      @Nullable Optional<String> e, Optional<ImmutableMap<String, Number>> f,\n"
        + "      Optional<Set<String>> g, Optional<Map<String, Set<String>>> h, Optional<String> i,\n"
        + "      @Nullable Optional<List<String>> j, Optional<String> k, Optional<List<String>> l,\n"
        + "      Optional<String> m, Optional<List<String>> n, OptionalInt o, OptionalLong p, OptionalDouble q,\n"
        + "      Optional<String> r) {\n"
        + "    super(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> optional__string_adapter;\n"
        + "    private volatile TypeAdapter<int[]> optional__array__int_adapter;\n"
        + "    private volatile TypeAdapter<Integer> optional__integer_adapter;\n"
        + "    private volatile TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter;\n"
        + "    private volatile TypeAdapter<Set<String>> optional__set__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter;\n"
        + "    private volatile TypeAdapter<List<String>> optional__list__string_adapter;\n"
        + "    private volatile TypeAdapter<Integer> optionalInt_adapter;\n"
        + "    private volatile TypeAdapter<Long> optionalLong_adapter;\n"
        + "    private volatile TypeAdapter<Double> optionalDouble_adapter;\n"
        + "    private final Gson gson;\n"
        + "    private Optional<String> defaultA = Optional.empty();\n"
        + "    private Optional<int[]> defaultB = Optional.empty();\n"
        + "    private Optional<Integer> defaultC = Optional.empty();\n"
        + "    private Optional<String> defaultD = Optional.empty();\n"
        + "    private Optional<String> defaultE = Optional.empty();\n"
        + "    private Optional<ImmutableMap<String, Number>> defaultF = Optional.empty();\n"
        + "    private Optional<Set<String>> defaultG = Optional.empty();\n"
        + "    private Optional<Map<String, Set<String>>> defaultH = Optional.empty();\n"
        + "    private Optional<String> defaultI = Optional.empty();\n"
        + "    private Optional<List<String>> defaultJ = Optional.empty();\n"
        + "    private Optional<String> defaultK = Optional.empty();\n"
        + "    private Optional<List<String>> defaultL = Optional.empty();\n"
        + "    private Optional<String> defaultM = Optional.empty();\n"
        + "    private Optional<List<String>> defaultN = Optional.empty();\n"
        + "    private OptionalInt defaultO = OptionalInt.empty();\n"
        + "    private OptionalLong defaultP = OptionalLong.empty();\n"
        + "    private OptionalDouble defaultQ = OptionalDouble.empty();\n"
        + "    private Optional<String> defaultR = Optional.empty();\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.a().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "        if (optional__array__int_adapter == null) {\n"
        + "          this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "        }\n"
        + "        optional__array__int_adapter.write(jsonWriter, object.b().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      if (object.c() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "        if (optional__integer_adapter == null) {\n"
        + "          this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        optional__integer_adapter.write(jsonWriter, object.c().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"_D\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.d().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"e\");\n"
        + "      if (object.e() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.e().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"f\");\n"
        + "      if (object.f() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "        if (optional__immutableMap__string_number_adapter == null) {\n"
        + "          this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "        }\n"
        + "        optional__immutableMap__string_number_adapter.write(jsonWriter, object.f().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"g\");\n"
        + "      if (object.g() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "        if (optional__set__string_adapter == null) {\n"
        + "          this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "        }\n"
        + "        optional__set__string_adapter.write(jsonWriter, object.g().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"h\");\n"
        + "      if (object.h() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "        if (optional__map__string_set__string_adapter == null) {\n"
        + "          this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "        }\n"
        + "        optional__map__string_set__string_adapter.write(jsonWriter, object.h().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"_I\");\n"
        + "      if (object.i() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.i().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"j\");\n"
        + "      if (object.j() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.j().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"k\");\n"
        + "      if (object.k() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.k().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"l\");\n"
        + "      if (object.l() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.l().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"m\");\n"
        + "      if (object.m() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.m().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"n\");\n"
        + "      if (object.n() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.n().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.name(\"o\");\n"
        + "      if (object.o() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Integer> optionalInt_adapter = this.optionalInt_adapter;\n"
        + "        if (optionalInt_adapter == null) {\n"
        + "          this.optionalInt_adapter = optionalInt_adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        optionalInt_adapter.write(jsonWriter, object.o().orElse(0));\n"
        + "      }\n"
        + "      jsonWriter.name(\"p\");\n"
        + "      if (object.p() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Long> optionalLong_adapter = this.optionalLong_adapter;\n"
        + "        if (optionalLong_adapter == null) {\n"
        + "          this.optionalLong_adapter = optionalLong_adapter = gson.getAdapter(Long.class);\n"
        + "        }\n"
        + "        optionalLong_adapter.write(jsonWriter, object.p().orElse(0L));\n"
        + "      }\n"
        + "      jsonWriter.name(\"q\");\n"
        + "      if (object.q() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Double> optionalDouble_adapter = this.optionalDouble_adapter;\n"
        + "        if (optionalDouble_adapter == null) {\n"
        + "          this.optionalDouble_adapter = optionalDouble_adapter = gson.getAdapter(Double.class);\n"
        + "        }\n"
        + "        optionalDouble_adapter.write(jsonWriter, object.q().orElse(0d));\n"
        + "      }\n"
        + "      jsonWriter.name(\"r\");\n"
        + "      if (object.r() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.r().orElse(null));\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      Optional<String> a = this.defaultA;\n"
        + "      Optional<int[]> b = this.defaultB;\n"
        + "      Optional<Integer> c = this.defaultC;\n"
        + "      Optional<String> d = this.defaultD;\n"
        + "      Optional<String> e = this.defaultE;\n"
        + "      Optional<ImmutableMap<String, Number>> f = this.defaultF;\n"
        + "      Optional<Set<String>> g = this.defaultG;\n"
        + "      Optional<Map<String, Set<String>>> h = this.defaultH;\n"
        + "      Optional<String> i = this.defaultI;\n"
        + "      Optional<List<String>> j = this.defaultJ;\n"
        + "      Optional<String> k = this.defaultK;\n"
        + "      Optional<List<String>> l = this.defaultL;\n"
        + "      Optional<String> m = this.defaultM;\n"
        + "      Optional<List<String>> n = this.defaultN;\n"
        + "      OptionalInt o = this.defaultO;\n"
        + "      OptionalLong p = this.defaultP;\n"
        + "      OptionalDouble q = this.defaultQ;\n"
        + "      Optional<String> r = this.defaultR;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "            if (optional__array__int_adapter == null) {\n"
        + "              this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "            }\n"
        + "            b = Optional.of(optional__array__int_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "            if (optional__integer_adapter == null) {\n"
        + "              this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            c = Optional.of(optional__integer_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_D\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"e\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            e = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"f\": {\n"
        + "            TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "            if (optional__immutableMap__string_number_adapter == null) {\n"
        + "              this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "            }\n"
        + "            f = Optional.of(optional__immutableMap__string_number_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"g\": {\n"
        + "            TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "            if (optional__set__string_adapter == null) {\n"
        + "              this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "            }\n"
        + "            g = Optional.of(optional__set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"h\": {\n"
        + "            TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "            if (optional__map__string_set__string_adapter == null) {\n"
        + "              this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "            }\n"
        + "            h = Optional.of(optional__map__string_set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_I_1\":\n"
        + "          case \"_I_2\":\n"
        + "          case \"_I\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            i = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"j\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            j = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"k\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "            }\n"
        + "            k = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"l\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "            }\n"
        + "            l = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"m\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "            }\n"
        + "            m = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"n\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            n = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"o\": {\n"
        + "            TypeAdapter<Integer> optionalInt_adapter = this.optionalInt_adapter;\n"
        + "            if (optionalInt_adapter == null) {\n"
        + "              this.optionalInt_adapter = optionalInt_adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            o = OptionalInt.of(optionalInt_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"p\": {\n"
        + "            TypeAdapter<Long> optionalLong_adapter = this.optionalLong_adapter;\n"
        + "            if (optionalLong_adapter == null) {\n"
        + "              this.optionalLong_adapter = optionalLong_adapter = gson.getAdapter(Long.class);\n"
        + "            }\n"
        + "            p = OptionalLong.of(optionalLong_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"q\": {\n"
        + "            TypeAdapter<Double> optionalDouble_adapter = this.optionalDouble_adapter;\n"
        + "            if (optionalDouble_adapter == null) {\n"
        + "              this.optionalDouble_adapter = optionalDouble_adapter = gson.getAdapter(Double.class);\n"
        + "            }\n"
        + "            q = OptionalDouble.of(optionalDouble_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r);\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultA(String defaultA) {\n"
        + "      this.defaultA = Optional.ofNullable(defaultA);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultB(int[] defaultB) {\n"
        + "      this.defaultB = Optional.ofNullable(defaultB);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultC(Integer defaultC) {\n"
        + "      this.defaultC = Optional.ofNullable(defaultC);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultD(String defaultD) {\n"
        + "      this.defaultD = Optional.ofNullable(defaultD);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultE(String defaultE) {\n"
        + "      this.defaultE = Optional.ofNullable(defaultE);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultF(ImmutableMap<String, Number> defaultF) {\n"
        + "      this.defaultF = Optional.ofNullable(defaultF);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultG(Set<String> defaultG) {\n"
        + "      this.defaultG = Optional.ofNullable(defaultG);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultH(Map<String, Set<String>> defaultH) {\n"
        + "      this.defaultH = Optional.ofNullable(defaultH);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultI(String defaultI) {\n"
        + "      this.defaultI = Optional.ofNullable(defaultI);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultJ(List<String> defaultJ) {\n"
        + "      this.defaultJ = Optional.ofNullable(defaultJ);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultK(String defaultK) {\n"
        + "      this.defaultK = Optional.ofNullable(defaultK);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultL(List<String> defaultL) {\n"
        + "      this.defaultL = Optional.ofNullable(defaultL);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultM(String defaultM) {\n"
        + "      this.defaultM = Optional.ofNullable(defaultM);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultN(List<String> defaultN) {\n"
        + "      this.defaultN = Optional.ofNullable(defaultN);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultO(int defaultO) {\n"
        + "      this.defaultO = OptionalInt.of(defaultO);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultP(long defaultP) {\n"
        + "      this.defaultP = OptionalLong.of(defaultP);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultQ(double defaultQ) {\n"
        + "      this.defaultQ = OptionalDouble.of(defaultQ);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultR(String defaultR) {\n"
        + "      this.defaultR = Optional.ofNullable(defaultR);\n"
        + "      return this;\n"
        + "    }\n"
        + "  }\n"
        + "}\n"
    );

    // Collections do not default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + AutoValueGsonExtension.MUTABLE_ADAPTERS_WITH_DEFAULT_SETTERS + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);

    // Collections default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + AutoValueGsonExtension.MUTABLE_ADAPTERS_WITH_DEFAULT_SETTERS + "=true")
        .withCompilerOptions("-A" + COLLECTIONS_DEFAULT_TO_EMPTY + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test
  public void simpleWithGuavaOptional() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.gson.annotations.SerializedName;\n"
        + "import com.ryanharter.auto.value.gson.GsonTypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.common.base.Optional;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.TypeAdapterFactory;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import java.io.IOException;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        // Reference type
        + "public abstract Optional<String> a();\n"
        // Array type
        + "public abstract Optional<int[]> b();\n"
        // Boxed Primitive type
        + "public abstract Optional<Integer> c();\n"
        // SerializedName
        + "@SerializedName(\"_D\") public abstract Optional<String> d();\n"
        // Nullable type
        + "@Nullable abstract Optional<String> e();\n"
        // Parametrized type, multiple parameters
        + "public abstract Optional<ImmutableMap<String, Number>> f();\n"
        // Parametrized type, single parameter
        + "public abstract Optional<Set<String>> g();\n"
        // Nested parameterized type
        + "public abstract Optional<Map<String, Set<String>>> h();\n"
        // SerializedName with alternate
        + "@SerializedName(value = \"_I\", alternate = {\"_I_1\", \"_I_2\"}) public abstract Optional<String> i();\n"
        // Nullable collection type
        + "@Nullable public abstract Optional<List<String>> j();\n"
        // Custom adapter
        + "@GsonTypeAdapter(TestTypeAdapter.class) public abstract Optional<String> k();\n"
        // Custom adapter with generics
        + "@GsonTypeAdapter(TestListTypeAdapter.class) public abstract Optional<List<String>> l();\n"
        // Custom adapter factory
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<String> m();\n"
        // Custom adapter factory with generics
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<List<String>> n();\n"
        // Deeply nested parameterized type
        + "public abstract Optional<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> o();\n"
        +
        "  @AutoValue.Builder public static abstract class Builder {\n" +
        "    public abstract Builder a(String a);\n" +
        "    public abstract Builder b(int[] b);\n" +
        "    public abstract Builder c(int c);\n" +
        "    public abstract Builder d(String d);\n" +
        "    public abstract Builder e(String e);\n" +
        "    public abstract Builder f(ImmutableMap<String, Number> f);\n" +
        "    public abstract Builder g(Set<String> g);\n" +
        "    public abstract Builder h(Map<String, Set<String>> h);\n" +
        "    public abstract Builder i(String i);\n" +
        "    public abstract Builder j(List<String> j);\n" +
        "    public abstract Builder k(String k);\n" +
        "    public abstract Builder l(List<String> l);\n" +
        "    public abstract Builder m(String m);\n" +
        "    public abstract Builder n(List<String> n);\n" +
        "    public abstract Builder o(Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>> o);\n" +
        "    public abstract Test build();\n" +
        "  }\n" +
        "  public static class TestTypeAdapter extends TypeAdapter<String> {\n" +
        "    @Override public void write(JsonWriter out, String value) throws IOException {}\n" +
        "    @Override public String read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestListTypeAdapter extends TypeAdapter<List<String>> {\n" +
        "    @Override public void write(JsonWriter out, List<String> value) throws IOException {}\n" +
        "    @Override public List<String> read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestTypeAdapterFactory implements TypeAdapterFactory {\n" +
        "    @Override public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> type) { return null; }\n" +
        "  }\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", ""
        + "package test;\n"
        + "\n"
        + "import com.google.common.base.Optional;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Integer;\n"
        + "import java.lang.Number;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(Optional<String> a, Optional<int[]> b, Optional<Integer> c, Optional<String> d,\n"
        + "      @Nullable Optional<String> e, Optional<ImmutableMap<String, Number>> f,\n"
        + "      Optional<Set<String>> g, Optional<Map<String, Set<String>>> h, Optional<String> i,\n"
        + "      @Nullable Optional<List<String>> j, Optional<String> k, Optional<List<String>> l,\n"
        + "      Optional<String> m, Optional<List<String>> n,\n"
        + "      Optional<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> o) {\n"
        + "    super(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> optional__string_adapter;\n"
        + "    private volatile TypeAdapter<int[]> optional__array__int_adapter;\n"
        + "    private volatile TypeAdapter<Integer> optional__integer_adapter;\n"
        + "    private volatile TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter;\n"
        + "    private volatile TypeAdapter<Set<String>> optional__set__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter;\n"
        + "    private volatile TypeAdapter<List<String>> optional__list__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> optional__map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "    private final Gson gson;\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.a().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "        if (optional__array__int_adapter == null) {\n"
        + "          this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "        }\n"
        + "        optional__array__int_adapter.write(jsonWriter, object.b().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      if (object.c() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "        if (optional__integer_adapter == null) {\n"
        + "          this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        optional__integer_adapter.write(jsonWriter, object.c().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_D\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.d().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"e\");\n"
        + "      if (object.e() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.e().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"f\");\n"
        + "      if (object.f() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "        if (optional__immutableMap__string_number_adapter == null) {\n"
        + "          this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "        }\n"
        + "        optional__immutableMap__string_number_adapter.write(jsonWriter, object.f().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"g\");\n"
        + "      if (object.g() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "        if (optional__set__string_adapter == null) {\n"
        + "          this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "        }\n"
        + "        optional__set__string_adapter.write(jsonWriter, object.g().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"h\");\n"
        + "      if (object.h() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "        if (optional__map__string_set__string_adapter == null) {\n"
        + "          this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "        }\n"
        + "        optional__map__string_set__string_adapter.write(jsonWriter, object.h().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_I\");\n"
        + "      if (object.i() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.i().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"j\");\n"
        + "      if (object.j() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.j().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"k\");\n"
        + "      if (object.k() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.k().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"l\");\n"
        + "      if (object.l() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.l().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"m\");\n"
        + "      if (object.m() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.m().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"n\");\n"
        + "      if (object.n() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.n().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"o\");\n"
        + "      if (object.o() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> optional__map__string_map__string_map__string_map__string_map__string_string_adapter = this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "        if (optional__map__string_map__string_map__string_map__string_map__string_string_adapter == null) {\n"
        + "          this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter = optional__map__string_map__string_map__string_map__string_map__string_string_adapter = (TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, String.class).getType()).getType()).getType()).getType()));\n"
        + "        }\n"
        + "        optional__map__string_map__string_map__string_map__string_map__string_string_adapter.write(jsonWriter, object.o().orNull());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      Optional<String> a = Optional.absent();\n"
        + "      Optional<int[]> b = Optional.absent();\n"
        + "      Optional<Integer> c = Optional.absent();\n"
        + "      Optional<String> d = Optional.absent();\n"
        + "      Optional<String> e = Optional.absent();\n"
        + "      Optional<ImmutableMap<String, Number>> f = Optional.absent();\n"
        + "      Optional<Set<String>> g = Optional.absent();\n"
        + "      Optional<Map<String, Set<String>>> h = Optional.absent();\n"
        + "      Optional<String> i = Optional.absent();\n"
        + "      Optional<List<String>> j = Optional.absent();\n"
        + "      Optional<String> k = Optional.absent();\n"
        + "      Optional<List<String>> l = Optional.absent();\n"
        + "      Optional<String> m = Optional.absent();\n"
        + "      Optional<List<String>> n = Optional.absent();\n"
        + "      Optional<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> o = Optional.absent();\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "            if (optional__array__int_adapter == null) {\n"
        + "              this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "            }\n"
        + "            b = Optional.of(optional__array__int_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "            if (optional__integer_adapter == null) {\n"
        + "              this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            c = Optional.of(optional__integer_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_D\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"e\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            e = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"f\": {\n"
        + "            TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "            if (optional__immutableMap__string_number_adapter == null) {\n"
        + "              this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "            }\n"
        + "            f = Optional.of(optional__immutableMap__string_number_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"g\": {\n"
        + "            TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "            if (optional__set__string_adapter == null) {\n"
        + "              this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "            }\n"
        + "            g = Optional.of(optional__set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"h\": {\n"
        + "            TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "            if (optional__map__string_set__string_adapter == null) {\n"
        + "              this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "            }\n"
        + "            h = Optional.of(optional__map__string_set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_I_1\":\n"
        + "          case \"_I_2\":\n"
        + "          case \"_I\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            i = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"j\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            j = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"k\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "            }\n"
        + "            k = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"l\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "            }\n"
        + "            l = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"m\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "            }\n"
        + "            m = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"n\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            n = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"o\": {\n"
        + "            TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>> optional__map__string_map__string_map__string_map__string_map__string_string_adapter = this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter;\n"
        + "            if (optional__map__string_map__string_map__string_map__string_map__string_string_adapter == null) {\n"
        + "              this.optional__map__string_map__string_map__string_map__string_map__string_string_adapter = optional__map__string_map__string_map__string_map__string_map__string_string_adapter = (TypeAdapter<Map<String, Map<String, Map<String, Map<String, Map<String, String>>>>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Map.class, String.class, String.class).getType()).getType()).getType()).getType()));\n"
        + "            }\n"
        + "            o = Optional.of(optional__map__string_map__string_map__string_map__string_map__string_string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o);\n"
        + "    }\n"
        + "  }\n"
        + "}\n"
    );

    // Collections default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + COLLECTIONS_DEFAULT_TO_EMPTY + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);

    // Collections do not default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }

  @Test
  public void simpleWithGuavaOptionalAndDefaults() {
    JavaFileObject source = JavaFileObjects.forSourceString("test.Test", ""
        + "package test;\n"
        + "import com.google.gson.annotations.SerializedName;\n"
        + "import com.ryanharter.auto.value.gson.GsonTypeAdapter;\n"
        + "import com.ryanharter.auto.value.gson.Ignore;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import com.google.auto.value.AutoValue;\n"
        + "import com.google.common.base.Optional;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.TypeAdapterFactory;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import java.io.IOException;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "@AutoValue public abstract class Test {\n"
        + "  public static TypeAdapter<Test> typeAdapter(Gson gson) {\n"
        + "    return new AutoValue_Test.GsonTypeAdapter(gson);\n"
        + "  }\n"
        // Reference type
        + "public abstract Optional<String> a();\n"
        // Array type
        + "public abstract Optional<int[]> b();\n"
        // Boxed primitive type
        + "public abstract Optional<Integer> c();\n"
        // SerializedName
        + "@SerializedName(\"_D\") public abstract Optional<String> d();\n"
        // Nullable type
        + "@Nullable abstract Optional<String> e();\n"
        // Parametrized type, multiple parameters
        + "public abstract Optional<ImmutableMap<String, Number>> f();\n"
        // Parametrized type, single parameter
        + "public abstract Optional<Set<String>> g();\n"
        // Nested parameterized type
        + "public abstract Optional<Map<String, Set<String>>> h();\n"
        // SerializedName with alternate
        + "@SerializedName(value = \"_I\", alternate = {\"_I_1\", \"_I_2\"}) public abstract Optional<String> i();\n"
        // Nullable collection type
        + "@Nullable public abstract Optional<List<String>> j();\n"
        // Custom adapter
        + "@GsonTypeAdapter(TestTypeAdapter.class) public abstract Optional<String> k();\n"
        // Custom adapter with generics
        + "@GsonTypeAdapter(TestListTypeAdapter.class) public abstract Optional<List<String>> l();\n"
        // Custom adapter factory
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<String> m();\n"
        // Custom adapter factory with generics
        + "@GsonTypeAdapter(TestTypeAdapterFactory.class) public abstract Optional<List<String>> n();\n"
        // Test case for ignore-deserialize-but-not-nullable
        + "@Ignore(Ignore.Type.DESERIALIZATION) public abstract Optional<String> o();\n"
        +
        "  @AutoValue.Builder public static abstract class Builder {\n" +
        "    public abstract Builder a(String a);\n" +
        "    public abstract Builder b(int[] b);\n" +
        "    public abstract Builder c(int c);\n" +
        "    public abstract Builder d(String d);\n" +
        "    public abstract Builder e(String e);\n" +
        "    public abstract Builder f(ImmutableMap<String, Number> f);\n" +
        "    public abstract Builder g(Set<String> g);\n" +
        "    public abstract Builder h(Map<String, Set<String>> h);\n" +
        "    public abstract Builder i(String i);\n" +
        "    public abstract Builder j(List<String> j);\n" +
        "    public abstract Builder k(String k);\n" +
        "    public abstract Builder l(List<String> l);\n" +
        "    public abstract Builder m(String m);\n" +
        "    public abstract Builder n(List<String> n);\n" +
        "    public abstract Builder o(String o);\n" +
        "    public abstract Test build();\n" +
        "  }\n" +
        "  public static class TestTypeAdapter extends TypeAdapter<String> {\n" +
        "    @Override public void write(JsonWriter out, String value) throws IOException {}\n" +
        "    @Override public String read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestListTypeAdapter extends TypeAdapter<List<String>> {\n" +
        "    @Override public void write(JsonWriter out, List<String> value) throws IOException {}\n" +
        "    @Override public List<String> read(JsonReader in) throws IOException { return null; }\n" +
        "  }\n" +
        "  public static class TestTypeAdapterFactory implements TypeAdapterFactory {\n" +
        "    @Override public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> type) { return null; }\n" +
        "  }\n"
        + "}\n"
    );

    JavaFileObject expected = JavaFileObjects.forSourceString("test/AutoValue_Test", ""
        + "package test;\n"
        + "\n"
        + "import com.google.common.base.Optional;\n"
        + "import com.google.common.collect.ImmutableMap;\n"
        + "import com.google.gson.Gson;\n"
        + "import com.google.gson.TypeAdapter;\n"
        + "import com.google.gson.reflect.TypeToken;\n"
        + "import com.google.gson.stream.JsonReader;\n"
        + "import com.google.gson.stream.JsonToken;\n"
        + "import com.google.gson.stream.JsonWriter;\n"
        + "import com.ryanharter.auto.value.gson.Nullable;\n"
        + "import java.io.IOException;\n"
        + "import java.lang.Integer;\n"
        + "import java.lang.Number;\n"
        + "import java.lang.Override;\n"
        + "import java.lang.String;\n"
        + "import java.lang.SuppressWarnings;\n"
        + "import java.util.List;\n"
        + "import java.util.Map;\n"
        + "import java.util.Set;\n"
        + "import javax.annotation.Generated;\n"
        + "\n"
        + "@Generated(\n"
        + "    value = \"com.ryanharter.auto.value.gson.AutoValueGsonExtension\",\n"
        + "    comments = \"https://github.com/rharter/auto-value-gson\"\n"
        + ")\n"
        + "final class AutoValue_Test extends $AutoValue_Test {\n"
        + "  AutoValue_Test(Optional<String> a, Optional<int[]> b, Optional<Integer> c, Optional<String> d,\n"
        + "      @Nullable Optional<String> e, Optional<ImmutableMap<String, Number>> f,\n"
        + "      Optional<Set<String>> g, Optional<Map<String, Set<String>>> h, Optional<String> i,\n"
        + "      @Nullable Optional<List<String>> j, Optional<String> k, Optional<List<String>> l,\n"
        + "      Optional<String> m, Optional<List<String>> n, Optional<String> o) {\n"
        + "    super(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o);\n"
        + "  }\n"
        + "\n"
        + "  public static final class GsonTypeAdapter extends TypeAdapter<Test> {\n"
        + "    private volatile TypeAdapter<String> optional__string_adapter;\n"
        + "    private volatile TypeAdapter<int[]> optional__array__int_adapter;\n"
        + "    private volatile TypeAdapter<Integer> optional__integer_adapter;\n"
        + "    private volatile TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter;\n"
        + "    private volatile TypeAdapter<Set<String>> optional__set__string_adapter;\n"
        + "    private volatile TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter;\n"
        + "    private volatile TypeAdapter<List<String>> optional__list__string_adapter;\n"
        + "    private final Gson gson;\n"
        + "    private Optional<String> defaultA = Optional.absent();\n"
        + "    private Optional<int[]> defaultB = Optional.absent();\n"
        + "    private Optional<Integer> defaultC = Optional.absent();\n"
        + "    private Optional<String> defaultD = Optional.absent();\n"
        + "    private Optional<String> defaultE = Optional.absent();\n"
        + "    private Optional<ImmutableMap<String, Number>> defaultF = Optional.absent();\n"
        + "    private Optional<Set<String>> defaultG = Optional.absent();\n"
        + "    private Optional<Map<String, Set<String>>> defaultH = Optional.absent();\n"
        + "    private Optional<String> defaultI = Optional.absent();\n"
        + "    private Optional<List<String>> defaultJ = Optional.absent();\n"
        + "    private Optional<String> defaultK = Optional.absent();\n"
        + "    private Optional<List<String>> defaultL = Optional.absent();\n"
        + "    private Optional<String> defaultM = Optional.absent();\n"
        + "    private Optional<List<String>> defaultN = Optional.absent();\n"
        + "    private Optional<String> defaultO = Optional.absent();\n"
        + "    public GsonTypeAdapter(Gson gson) {\n"
        + "      this.gson = gson;\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public void write(JsonWriter jsonWriter, Test object) throws IOException {\n"
        + "      if (object == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "        return;\n"
        + "      }\n"
        + "      jsonWriter.beginObject();\n"
        + "      jsonWriter.name(\"a\");\n"
        + "      if (object.a() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.a().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"b\");\n"
        + "      if (object.b() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "        if (optional__array__int_adapter == null) {\n"
        + "          this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "        }\n"
        + "        optional__array__int_adapter.write(jsonWriter, object.b().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"c\");\n"
        + "      if (object.c() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "        if (optional__integer_adapter == null) {\n"
        + "          this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "        }\n"
        + "        optional__integer_adapter.write(jsonWriter, object.c().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_D\");\n"
        + "      if (object.d() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.d().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"e\");\n"
        + "      if (object.e() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.e().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"f\");\n"
        + "      if (object.f() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "        if (optional__immutableMap__string_number_adapter == null) {\n"
        + "          this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "        }\n"
        + "        optional__immutableMap__string_number_adapter.write(jsonWriter, object.f().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"g\");\n"
        + "      if (object.g() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "        if (optional__set__string_adapter == null) {\n"
        + "          this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "        }\n"
        + "        optional__set__string_adapter.write(jsonWriter, object.g().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"h\");\n"
        + "      if (object.h() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "        if (optional__map__string_set__string_adapter == null) {\n"
        + "          this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "        }\n"
        + "        optional__map__string_set__string_adapter.write(jsonWriter, object.h().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"_I\");\n"
        + "      if (object.i() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.i().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"j\");\n"
        + "      if (object.j() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.j().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"k\");\n"
        + "      if (object.k() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.k().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"l\");\n"
        + "      if (object.l() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.l().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"m\");\n"
        + "      if (object.m() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.m().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"n\");\n"
        + "      if (object.n() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "        if (optional__list__string_adapter == null) {\n"
        + "          this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "        }\n"
        + "        optional__list__string_adapter.write(jsonWriter, object.n().orNull());\n"
        + "      }\n"
        + "      jsonWriter.name(\"o\");\n"
        + "      if (object.o() == null) {\n"
        + "        jsonWriter.nullValue();\n"
        + "      } else {\n"
        + "        TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "        if (optional__string_adapter == null) {\n"
        + "          this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "        }\n"
        + "        optional__string_adapter.write(jsonWriter, object.o().orNull());\n"
        + "      }\n"
        + "      jsonWriter.endObject();\n"
        + "    }\n"
        + "    @Override\n"
        + "    @SuppressWarnings(\"unchecked\")\n"
        + "    public Test read(JsonReader jsonReader) throws IOException {\n"
        + "      if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "        jsonReader.nextNull();\n"
        + "        return null;\n"
        + "      }\n"
        + "      jsonReader.beginObject();\n"
        + "      Optional<String> a = this.defaultA;\n"
        + "      Optional<int[]> b = this.defaultB;\n"
        + "      Optional<Integer> c = this.defaultC;\n"
        + "      Optional<String> d = this.defaultD;\n"
        + "      Optional<String> e = this.defaultE;\n"
        + "      Optional<ImmutableMap<String, Number>> f = this.defaultF;\n"
        + "      Optional<Set<String>> g = this.defaultG;\n"
        + "      Optional<Map<String, Set<String>>> h = this.defaultH;\n"
        + "      Optional<String> i = this.defaultI;\n"
        + "      Optional<List<String>> j = this.defaultJ;\n"
        + "      Optional<String> k = this.defaultK;\n"
        + "      Optional<List<String>> l = this.defaultL;\n"
        + "      Optional<String> m = this.defaultM;\n"
        + "      Optional<List<String>> n = this.defaultN;\n"
        + "      Optional<String> o = this.defaultO;\n"
        + "      while (jsonReader.hasNext()) {\n"
        + "        String _name = jsonReader.nextName();\n"
        + "        if (jsonReader.peek() == JsonToken.NULL) {\n"
        + "          jsonReader.nextNull();\n"
        + "          continue;\n"
        + "        }\n"
        + "        switch (_name) {\n"
        + "          case \"a\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            a = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"b\": {\n"
        + "            TypeAdapter<int[]> optional__array__int_adapter = this.optional__array__int_adapter;\n"
        + "            if (optional__array__int_adapter == null) {\n"
        + "              this.optional__array__int_adapter = optional__array__int_adapter = gson.getAdapter(int[].class);\n"
        + "            }\n"
        + "            b = Optional.of(optional__array__int_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"c\": {\n"
        + "            TypeAdapter<Integer> optional__integer_adapter = this.optional__integer_adapter;\n"
        + "            if (optional__integer_adapter == null) {\n"
        + "              this.optional__integer_adapter = optional__integer_adapter = gson.getAdapter(Integer.class);\n"
        + "            }\n"
        + "            c = Optional.of(optional__integer_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_D\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            d = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"e\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            e = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"f\": {\n"
        + "            TypeAdapter<ImmutableMap<String, Number>> optional__immutableMap__string_number_adapter = this.optional__immutableMap__string_number_adapter;\n"
        + "            if (optional__immutableMap__string_number_adapter == null) {\n"
        + "              this.optional__immutableMap__string_number_adapter = optional__immutableMap__string_number_adapter = (TypeAdapter<ImmutableMap<String, Number>>) gson.getAdapter(TypeToken.getParameterized(ImmutableMap.class, String.class, Number.class));\n"
        + "            }\n"
        + "            f = Optional.of(optional__immutableMap__string_number_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"g\": {\n"
        + "            TypeAdapter<Set<String>> optional__set__string_adapter = this.optional__set__string_adapter;\n"
        + "            if (optional__set__string_adapter == null) {\n"
        + "              this.optional__set__string_adapter = optional__set__string_adapter = (TypeAdapter<Set<String>>) gson.getAdapter(TypeToken.getParameterized(Set.class, String.class));\n"
        + "            }\n"
        + "            g = Optional.of(optional__set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"h\": {\n"
        + "            TypeAdapter<Map<String, Set<String>>> optional__map__string_set__string_adapter = this.optional__map__string_set__string_adapter;\n"
        + "            if (optional__map__string_set__string_adapter == null) {\n"
        + "              this.optional__map__string_set__string_adapter = optional__map__string_set__string_adapter = (TypeAdapter<Map<String, Set<String>>>) gson.getAdapter(TypeToken.getParameterized(Map.class, String.class, TypeToken.getParameterized(Set.class, String.class).getType()));\n"
        + "            }\n"
        + "            h = Optional.of(optional__map__string_set__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"_I_1\":\n"
        + "          case \"_I_2\":\n"
        + "          case \"_I\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = gson.getAdapter(String.class);\n"
        + "            }\n"
        + "            i = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"j\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) gson.getAdapter(TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            j = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"k\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapter();\n"
        + "            }\n"
        + "            k = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"l\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = new Test.TestListTypeAdapter();\n"
        + "            }\n"
        + "            l = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"m\": {\n"
        + "            TypeAdapter<String> optional__string_adapter = this.optional__string_adapter;\n"
        + "            if (optional__string_adapter == null) {\n"
        + "              this.optional__string_adapter = optional__string_adapter = new Test.TestTypeAdapterFactory().create(gson, TypeToken.get(String.class));\n"
        + "            }\n"
        + "            m = Optional.of(optional__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          case \"n\": {\n"
        + "            TypeAdapter<List<String>> optional__list__string_adapter = this.optional__list__string_adapter;\n"
        + "            if (optional__list__string_adapter == null) {\n"
        + "              this.optional__list__string_adapter = optional__list__string_adapter = (TypeAdapter<List<String>>) new Test.TestTypeAdapterFactory().create(gson, TypeToken.getParameterized(List.class, String.class));\n"
        + "            }\n"
        + "            n = Optional.of(optional__list__string_adapter.read(jsonReader));\n"
        + "            break;\n"
        + "          }\n"
        + "          default: {\n"
        + "            jsonReader.skipValue();\n"
        + "          }\n"
        + "        }\n"
        + "      }\n"
        + "      jsonReader.endObject();\n"
        + "      return new AutoValue_Test(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o);\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultA(String defaultA) {\n"
        + "      this.defaultA = Optional.fromNullable(defaultA);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultB(int[] defaultB) {\n"
        + "      this.defaultB = Optional.fromNullable(defaultB);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultC(Integer defaultC) {\n"
        + "      this.defaultC = Optional.fromNullable(defaultC);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultD(String defaultD) {\n"
        + "      this.defaultD = Optional.fromNullable(defaultD);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultE(String defaultE) {\n"
        + "      this.defaultE = Optional.fromNullable(defaultE);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultF(ImmutableMap<String, Number> defaultF) {\n"
        + "      this.defaultF = Optional.fromNullable(defaultF);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultG(Set<String> defaultG) {\n"
        + "      this.defaultG = Optional.fromNullable(defaultG);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultH(Map<String, Set<String>> defaultH) {\n"
        + "      this.defaultH = Optional.fromNullable(defaultH);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultI(String defaultI) {\n"
        + "      this.defaultI = Optional.fromNullable(defaultI);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultJ(List<String> defaultJ) {\n"
        + "      this.defaultJ = Optional.fromNullable(defaultJ);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultK(String defaultK) {\n"
        + "      this.defaultK = Optional.fromNullable(defaultK);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultL(List<String> defaultL) {\n"
        + "      this.defaultL = Optional.fromNullable(defaultL);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultM(String defaultM) {\n"
        + "      this.defaultM = Optional.fromNullable(defaultM);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultN(List<String> defaultN) {\n"
        + "      this.defaultN = Optional.fromNullable(defaultN);\n"
        + "      return this;\n"
        + "    }\n"
        + "    public GsonTypeAdapter setDefaultO(String defaultO) {\n"
        + "      this.defaultO = Optional.fromNullable(defaultO);\n"
        + "      return this;\n"
        + "    }\n"
        + "  }\n"
        + "}\n"
    );

    // Collections do not default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + AutoValueGsonExtension.MUTABLE_ADAPTERS_WITH_DEFAULT_SETTERS + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);

    // Collections default to empty
    assertAbout(javaSources())
        .that(Arrays.asList(nullable, source))
        .withCompilerOptions("-A" + AutoValueGsonExtension.MUTABLE_ADAPTERS_WITH_DEFAULT_SETTERS + "=true")
        .withCompilerOptions("-A" + COLLECTIONS_DEFAULT_TO_EMPTY + "=true")
        .processedWith(new AutoValueProcessor())
        .compilesWithoutError()
        .and()
        .generatesSources(expected);
  }
}
